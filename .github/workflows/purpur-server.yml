name: Minecraft Purpur Server Repo-Sync

on:
  workflow_dispatch:

permissions:
  contents: write   # erlaubt github-actions, ins Repo zu pushen

jobs:
  start-server:
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken – immer das komplette Repo
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      # 1b. Force-reset, um sicher auf den neuesten Stand zu kommen
      - name: Reset to latest
        run: |
          git fetch origin main
          git reset --hard origin/main

      # 2. Java 21 installieren
      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      # 3. RAM-Verfügbarkeit prüfen
      - name: Check available RAM
        run: free -h

      # 4. Minecraft Server starten (max 15 GB RAM)
      - name: Start Minecraft Server
        run: |
          cd $GITHUB_WORKSPACE/minecraft_server
          java -Xmx15G -Xms1G -jar purpur.jar nogui || true

      # 5. Änderungen zurück ins Repo committen und bedingungslos pushen
      - name: Force-push server data to repo
        run: |
          cd $GITHUB_WORKSPACE
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A minecraft_server
          git commit -m "Auto-save Minecraft server data" || echo "No changes to commit"
          git push origin HEAD:main --force
