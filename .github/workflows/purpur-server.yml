name: Minecraft Purpur Server mit Autosave-Backup

on:
  workflow_dispatch:

permissions:
  contents: write   # GitHub Actions darf ins Repo pushen

jobs:
  start-server:
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Java 21 installieren
      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      # 3. Minecraft Server starten (max 15 GB RAM) im Hintergrund
      - name: Start Minecraft Server
        run: |
          cd $GITHUB_WORKSPACE/minecraft_server
          java -Xmx15G -Xms1G -jar purpur.jar nogui &
          echo $! > server.pid

      # 4. Kontinuierlich Autosave-Ordner erstellen und pushen
      - name: Continuous autosave backup
        run: |
          while kill -0 $(cat minecraft_server/server.pid) 2>/dev/null; do
            echo "=== Autosave Backup Loop ==="

            # Kopiere die Welt-Ordner in autosave-Verzeichnisse
            rsync -a --delete minecraft_server/world/ $GITHUB_WORKSPACE/autosave-world/
            rsync -a --delete minecraft_server/world_nether/ $GITHUB_WORKSPACE/autosave-world_nether/
            rsync -a --delete minecraft_server/world_the_end/ $GITHUB_WORKSPACE/autosave-world_the_end/

            # Commit & push der Autosave-Ordner
            cd $GITHUB_WORKSPACE
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add autosave-world autosave-world_nether autosave-world_the_end || true
            git commit -m "Autosave backup $(date)" || true
            git push --force || true

            sleep 60  # jede Minute
          done
