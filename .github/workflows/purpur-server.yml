name: Minecraft Purpur Server Auto-Save & Repo Sync

on:
  workflow_dispatch:

permissions:
  contents: write   # erlaubt github-actions, ins Repo zu pushen

jobs:
  start-server:
    runs-on: ubuntu-latest

    steps:
      # 1. Repository auschecken – immer das komplette Repo
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      # 1b. Force-reset auf neuesten Stand
      - name: Reset to latest
        run: |
          git fetch origin main
          git reset --hard origin/main

      # 2. Java 21 installieren
      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      # 3. RAM prüfen
      - name: Check available RAM
        run: free -h

      # 4. Minecraft Server starten (max 15 GB RAM) im Hintergrund
      - name: Start Minecraft Server
        run: |
          cd $GITHUB_WORKSPACE/minecraft_server
          java -Xmx15G -Xms1G -jar purpur.jar nogui &
          echo $! > server.pid

      # 5. Kontinuierlich Force Push mit Save-All
      - name: Continuous Save-All & Force Push
        run: |
          while kill -0 $(cat minecraft_server/server.pid) 2>/dev/null; do
            echo "=== Save-All & Force Push Loop ==="

            cd $GITHUB_WORKSPACE/minecraft_server

            # 1. Save-All ausführen über den Server
            if [ -f server.pid ]; then
              echo "save-all" | nc -U minecraft_server/server.pipe || echo "Save-All failed, ignored"
              sleep 5 # kurz warten, dass alles geschrieben wird
            fi

            # 2. Git vorbereiten
            cd $GITHUB_WORKSPACE
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            # 3. Alle Dateien hinzufügen, temporäre Dateien ignorieren
            rsync -a --ignore-errors --exclude='*.tmp' --exclude='session.lock' minecraft_server/ minecraft_server/

            # 4. Commit & Force Push
            git add -A minecraft_server || true
            git commit -m "Auto Save-All backup $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
            git push origin HEAD:main --force || echo "Push failed, ignored"

            # 5. 60 Sekunden warten
            sleep 60
          done
